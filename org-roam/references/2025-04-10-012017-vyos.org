:PROPERTIES:
:ID:       fe7713cb-166a-46c1-8a1d-8ceca7e61691
:END:
#+title: VyOS
#+date: [2025-04-10 Thu 01:20]

* Pre-requires
+ [[id:7c5d059e-dbde-4d4c-939d-bdfe5a674123][enable copy-paste functionality in the Proxmox noVNC console]]
  
* Introduction
VyOS is an open source network operating system Linux distribution based on [[id:0c65c1a6-4751-4290-876f-6c5ad7694068][Debian]].

VyOS provides a free routing platform that competes directly with other commercially available solutions from well-known network providers. Because VyOS is run on standard amd64 systems, it can be used as a router and firewall platform for cloud deployments. VyOS can also be optimized to achieve routing at 100Gbps.

* Features
** Routing and Protocols
+ [[id:e7b30b16-d942-4c41-ba19-14245c12a572][BGP]]
+ [[id:fb3e12fc-98fb-45a5-8474-a52b1743738b][OSPF]]

** Monitoring
+ [[id:ebc7a85b-cb33-4b29-93f9-0c2d5215bc7a][Prometheus]]/[[id:9f3cd2be-e9b5-4c01-b457-445951a17175][Grafana]]

** High Availability and Load Balancing
+ [[id:e3bd261e-34a6-4c7a-9945-529fb8a363b7][VRRP]] for IPv4 and IPv6, ability to execute custom health checks and transition scripts


* Two VyOS routers to create a high availability gateway Example
** Scenario Overview
| Role           | Hostname | LAN IP         | Floating IP    | WAN Interface | LAN Interface | vrid |
|----------------+----------+----------------+----------------+---------------+---------------+------|
| Primary VyOS   | vyos-1   | 192.168.1.2/24 | 192.168.1.4/24 | wlan0         | eth0          |    4 |
| Secondary VyOS | vyos-2   | 192.168.1.3/24 | 192.168.1.4/24 | wlan0         | eth0          |    4 |
					
+ Floating IP: 192.168.1.4
This is what LAN clients use as their default gateway.
It automatically moves between vyos-1 and vyos-2 depending on availability.
+ LAN Subnet: 192.168.1.0/24
+ WAN Interface: wlan0 (connected to Wi-Fi)
+ LAN Interface: eth0 (wired)

* Installation on [[id:77bd7428-f1ee-4306-8d5a-62f38134dfc5][Proxmox VE]]
  
** Downloading VyOS rolling release

https://vyos.net/get/nightly-builds/
https://docs.vyos.io/en/latest/installation/virtual/proxmox.html
https://vyos.net/get/

** Installation
https://docs.vyos.io/en/latest/installation/install.html#live-installation
https://docs.vyos.io/en/latest/installation/install.html#permanent-installation

In order to proceed with a permanent installation:
Log into the VyOS live system (use the default credentials: vyos, vyos)
Run the *install image* command and follow the wizard

+ RAM: 2.00G
+ Precessors: 2
+ Hard Disk: 8G

** [[id:81f3a757-0a43-402b-a418-79ea92e93562][Proxmox PCI passthrough]]
*** How to get PCI ID
#+begin_src console
root@server5:~# ethtool -i eno3
driver: igb
version: 6.14.11-3-pve
firmware-version: 1.67, 0x800010eb, 22.5.7
expansion-rom-version: 
bus-info: 0000:09:00.0
supports-statistics: yes
supports-test: yes
supports-eeprom-access: yes
supports-register-dump: yes
supports-priv-flags: yes
#+end_src

Look for the bus-info line
#+begin_src file
bus-info: 0000:09:00.0
#+end_src
*** When should you enable “All Functions”?
+ ✅ Enable “All Functions” if:
  - The NIC has multiple functions (you see .0, .1, … in lspci), and
  - They are in the same IOMMU group, or the documentation recommends keeping them together.
  - You want the VM to fully own that physical card.
+ ❌ You can leave it unchecked if:
  - The card is simple (only .0), or
  - You intentionally want only one function (e.g., only one port) in the VM and keep the others on the host (but then watch IOMMU group warnings from Proxmox).

* Before you start
** list all of interfaces
#+begin_src bash
  show interfaces
#+end_src

* NAT gateway
https://docs.vyos.io/en/latest/quick-start.html
** Configuration Mode
By default, VyOS is in operational mode, and the command prompt displays a $. To configure VyOS, you will need to enter configuration mode, resulting in the command prompt displaying a #, as demonstrated below:
#+begin_src bash
vyos@vyos$ configure
vyos@vyos#
#+end_src
** Interface Configuration
Your outside/WAN interface will be eth0. It will receive its interface address via DHCP.
Your internal/LAN interface will be eth1, eth2. It will use a static IP address of 192.168.0.1/24.

** Outside/WAN
#+begin_src bash
set interfaces ethernet eth0 address dhcp
set interfaces ethernet eth0 description 'OUTSIDE'
#+end_src

*NOTE*: if is wifi, please please use the steps below

Create a WPA Supplicant Config for Open Hidden Wi-Fi

Edit or create the config file:
#+begin_src bash
sudo nano /etc/wpa_supplicant/wpa_supplicant.conf
#+end_src


Add the following:
#+begin_src file
ctrl_interface=/var/run/wpa_supplicant
update_config=1

network={
    ssid="YourHiddenSSID"
    scan_ssid=1
    key_mgmt=NONE
}
#+end_src


Explanation:

+ ssid → The exact name of your hidden Wi-Fi.
+ scan_ssid=1 → Required for hidden networks so that wpa_supplicant actively scans for it.
+ key_mgmt=NONE → Specifies an open network with no password.

Connect Using WPA Supplicant

Run wpa_supplicant in the background:
#+begin_src bash
sudo wpa_supplicant -B -i wlan0 -c /etc/wpa_supplicant/wpa_supplicant.conf
#+end_src

-B → Run in background.
-i wlan0 → Replace wlan0 with your actual interface name.
-c → Path to your config file.

Get an IP Address
Since the Wi-Fi has no password, you still need to obtain an IP from DHCP:
#+begin_src bash
sudo dhclient wlan0
#+end_src

*NOTE*: when we reboot the system, *wpa_supplicant* and *dhclient* will gone.
Solution:
VyOS provides a built-in hook script that runs automatically after the system applies its configuration at boot.
add below to file - /config/scripts/vyos-postconfig-bootup.script:
#+begin_src bash
sudo wpa_supplicant -B -i wlan0 -c /etc/wpa_supplicant/wpa_supplicant.conf
sudo dhclient wlan0
#+end_src

Verify your IP:
#+begin_src bash
ip addr show wlan0
#+end_src

Auto-Connect at Boot
#+begin_src bash
  sudo systemctl enable wpa_supplicant@wlan0.service
  sudo systemctl start wpa_supplicant@wlan0.service
#+end_src

#+begin_src bash
show interfaces wireless info
#+end_src

Use this command to view operational status and wireless-specific information about all wireless interfaces.

If you have more than one port for LAN, please follow below create a bridge and add interfaces to the bridge. If only one interface for LAN jump to next section.

** Multiple-ports for LAN
*** Create a Bridge Interface
Start by creating a bridge interface (e.g., br0) to aggregate your LAN ports:
#+begin_src bash
set interfaces bridge br0 description 'LAN bridge'
set interfaces bridge br0 stp
set interfaces bridge br0 address 192.168.1.5/24
#+end_src
+ stp enables the [[id:b5b8bfb0-70f8-4c51-86a7-073b043c3546][spanning tree protocol (stp)]] to prevent loops.
+ Assign an IP address to the bridge for LAN gateway access.

*** Add LAN Interfaces to the Bridge
Assuming your LAN interfaces are eth1, and eth2, add them to the bridge:
#+begin_src bash
set interfaces bridge br0 member interface eth1
set interfaces bridge br0 member interface eth2
#+end_src
This configuration treats the specified interfaces as switch ports, allowing devices connected to them to communicate within the same LAN.

**** Show bridge info
#+begin_src bash
bridge link
#+end_src

** Single port for LAN
*** Primary
#+begin_src bash
configure
set interfaces ethernet eth0 description 'LAN'
set interfaces ethernet eth0 address '192.168.1.2/24'
commit; save
#+end_src
*** Secondary
#+begin_src bash
configure
set interfaces ethernet eth0 description 'LAN'
set interfaces ethernet eth0 address '192.168.1.3/24'
commit; save
#+end_src

** Configure NAT (masquerade) LAN→WAN
*** Primary (replace WAN_IF as appropriate)
#+begin_src bash
configure
set nat source rule 10 description 'NAT LAN to WAN'
set nat source rule 10 outbound-interface name 'WAN_IF'
set nat source rule 10 source address '192.168.1.0/24'
set nat source rule 10 translation address 'masquerade'
commit; save
#+end_src

*** Secondary (replace WAN_IF as appropriate)
#+begin_src bash
configure
set nat source rule 10 description 'NAT LAN to WAN'
set nat source rule 10 outbound-interface name 'WAN_IF'
set nat source rule 10 source address '192.168.1.0/24'
set nat source rule 10 translation address 'masquerade'
commit; save
#+end_src

** VRRP HA 
https://docs.vyos.io/en/latest/configuration/highavailability/

*** Key VRRP Settings
+ Virtual Address: 192.168.1.4 → The floating IP for LAN clients
+ Group Name: LAN
+ Priority:
  + Higher = preferred master
  + Primary uses 200
  + Secondary uses 100
+ Preempt - Preemption is enabled by default:
  + Ensures the primary regains master status when it comes back online.

*** Primary (higher priority)
#+begin_src bash
configure
set high-availability vrrp group LAN interface 'eth0'
set high-availability vrrp group LAN vrid '4'
set high-availability vrrp group LAN address '192.168.1.4/24'
set high-availability vrrp group LAN priority '200'
set high-availability vrrp group LAN advertise-interval '1'
commit
save
#+end_src
*** Secondary (lower priority)
#+begin_src bash
configure
set high-availability vrrp group LAN interface 'eth0'
set high-availability vrrp group LAN vrid '4'
set high-availability vrrp group LAN address '192.168.1.4/24'
set high-availability vrrp group LAN priority '100'
set high-availability vrrp group LAN advertise-interval '1'
commit
save
#+end_src

*NOTE*:
In VyOS the priority for a VRRP group must be in the VRRP-standard range:
+ 1–254 are valid priorities
+ 0 is “shut down this VRRP instance”
+ 255 is reserved for the VRRP owner and usually not allowed to be set arbitrarily

*** Verify VRRP status
#+begin_src bash
  show vrrp
#+end_src

** Configure conntrack-sync
*** add a sync-group that references this VRRP group
#+begin_src bash
configure
set high-availability vrrp sync-group SYNC member 'LAN'
commit
save
#+end_src
Do that on both routers (same name SYNC, same member LAN).

*** delete system conntrack modules
Conntrack helper modules are enabled by default, but they tend to cause more problems than they’re worth in complex networks. You can disable all of them at one go.
#+begin_src console
vyos@vyos:~$ configure
[edit]
vyos@vyos# delete system conntrack modules
vyos@vyos# commit
vyos@vyos# save
vyos@vyos# exit
#+end_src
*** Configure conntrack-sync (on both routers)
#+begin_src bash
configure

# Which protocols to sync
set service conntrack-sync accept-protocol 'tcp'
set service conntrack-sync accept-protocol 'udp'
set service conntrack-sync accept-protocol 'icmp'

# Tie conntrack-sync failover to your VRRP sync-group
set service conntrack-sync failover-mechanism vrrp sync-group 'SYNC'

# Interface used to send/receive sync packets
# (here we use LAN eth0 – good enough for lab; in production you’d often use a dedicated VLAN)
set service conntrack-sync interface 'eth0'

# Multicast group for sync traffic (default example from docs)
set service conntrack-sync mcast-group '225.0.0.50'

# Optional but nice:
set service conntrack-sync event-listen-queue-size '8'
set service conntrack-sync sync-queue-size '8'
set service conntrack-sync startup-resync

commit
save
#+end_src
*NOTE:* If you’d rather use unicast instead of multicast:
+ On R1: set service conntrack-sync interface eth0 peer 192.168.1.2
+ On R2: set service conntrack-sync interface eth0 peer 192.168.1.1
+ (and do not set mcast-group.)

#+begin_src bash
configure
delete service conntrack-sync mcast-group
commit
save
#+end_src
*** Make sure conntrack is actually used
Conntrack is automatically enabled if you have any NAT or stateful firewall rules. You can verify:
#+begin_src bash
run show conntrack table ipv4
#+end_src
You should see some entries (TCP/UDP flows).
*** Verify that conntrack sync is working
On both routers (operational mode, not in configure):
#+begin_src bash
run show conntrack-sync status
#+end_src
You want to see something like:
+ sync-interface : eth0
+ failover-mechanism : vrrp [sync-group SYNC]

Then check statistics:
#+begin_src bash
run show conntrack-sync statistics
#+end_src
+ On the master: active flows should appear in the internal cache.
+ On the backup: the same number of flows should appear in the external cache.
  
** [[id:e495805e-5687-4c21-8fbe-98c683b2fc18][DHCP]]/[[id:7bab7928-237d-4784-a42f-b85ef6874b9b][Domain Name Service (DNS)]] quick-start
The following settings will configure DHCP and DNS services on your internal/LAN network, where VyOS will act as the default gateway and DNS server.
+ The default gateway and DNS recursor address will be 192.168.0.1/24
+ The address range 192.168.0.2/24 - 192.168.0.8/24 will be reserved for static assignments
+ DHCP clients will be assigned IP addresses within the range of 192.168.0.9 - 192.168.0.254 and have a domain name of internal-network
+ DHCP leases will hold for one day (86400 seconds)
+ VyOS will serve as a full DNS recursor, replacing the need to utilize Google, Cloudflare, or other public DNS servers (which is good for privacy)
+ Only hosts from your internal/LAN network can use the DNS recursor

#+begin_src bash
set service dhcp-server shared-network-name LAN subnet 192.168.0.0/24 option default-router '192.168.0.1'
set service dhcp-server shared-network-name LAN subnet 192.168.0.0/24 option name-server '192.168.0.1'
set service dhcp-server shared-network-name LAN subnet 192.168.0.0/24 option domain-name 'vyos.net'
set service dhcp-server shared-network-name LAN subnet 192.168.0.0/24 lease '86400'
set service dhcp-server shared-network-name LAN subnet 192.168.0.0/24 range 0 start '192.168.0.9'
set service dhcp-server shared-network-name LAN subnet 192.168.0.0/24 range 0 stop '192.168.0.254'
set service dhcp-server shared-network-name LAN subnet 192.168.0.0/24 subnet-id '1'

set service dns forwarding cache-size '0'
set service dns forwarding listen-address '192.168.0.1'
set service dns forwarding allow-from '192.168.0.0/24'
#+end_src

** Setting [[id:7bab7928-237d-4784-a42f-b85ef6874b9b][Domain Name Service (DNS)]] client
On VyOS, the “DNS client” just means which DNS servers VyOS itself uses to resolve domain names (for ping, apt, curl, etc.)

#+begin_src bash
configure

# Add one or more DNS servers
set system name-server 192.168.1.21
set system name-server 192.168.1.22

# Optional: set a default search domain
set system domain-name example.com
set system domain-search example.com

commit
save
#+end_src

Check what’s configured:
#+begin_src bash
show system name-server
exit
#+end_src

Test
#+begin_src bash
ping google.com
dig @1.1.1.1 vyos.io
#+end_src

** VyOS Publishing and exposing ports (options)
:PROPERTIES:
:ID:       4664f459-c07e-40b3-9b2b-92bcfe217953
:END:
Do this on each gateway so the LAN's PC/VM always sees the gateway’s own IP as the source and replies to it.

+ NAT (Network Address Translation) = rewriting IP headers. Two directions:
  - SNAT: change the source address/port (usually on egress).
  - DNAT: change the destination address/port (usually on ingress).
  - Masquerade = a special kind of SNAT that automatically uses the egress interface’s current IP. It’s perfect when your WAN gets a dynamic address (DHCP/PPPoE) because it adapts if the IP changes or the link bounces.
  - PAT (Port Address Translation): the common case where NAT also rewrites ports so many inside hosts can share one public IP. VyOS SNAT/masquerade do this by default.

*** Show NAT rules
#+begin_src bash
show nat source rules
show nat destination rules
#+end_src
*** Show the live translation table
#+begin_src bash
show nat source translations
show nat destination translations
#+end_src

*** Show interfaces
#+begin_src bash
show interfaces
#+end_src
*** DNAT Setting
#+begin_src bash
  configure
  # DNAT: forward TCP/8006 from WAN to the 192.168.1.12:8006
  set nat destination rule 8006 description 'wlan0:8006 → 192.168.1.12:8006 (PVE)'
  set nat destination rule 8006 inbound-interface name 'wlan0' # e.g., <wan-if>
  
  set nat destination rule 8006 destination port 8006
  set nat destination rule 8006 protocol tcp
  set nat destination rule 8006 translation address 192.168.1.12
  set nat destination rule 8006 translation port 8006
  commit; save
#+end_src

*** SNAT Setting
#+begin_src bash
  configure
  # SNAT (hairpin for symmetry): make the 192.168.1.12 (server2) see current gateway 192.168.1.3
  set nat source rule 8006 description '192.168.1.12:8006 (PVE) -> wlan0:8006'
  set nat source rule 8006 outbound-interface name 'eth0'         # e.g., <lan-if>
  
  set nat source rule 8006 destination address 192.168.1.12
  set nat source rule 8006 protocol tcp
  set nat source rule 8006 destination port 8006
  set nat source rule 8006 translation address 192.168.1.3  # Gateway IP
  commit; save
#+end_src

*** [[id:f7904304-e3e3-484c-b541-349030a56fe3][Firewall]]
If you run a WAN input firewall, allow TCP/8006 to the gateway (the DNAT will hand it to the server2 (PVE)):
https://docs.vyos.io/en/latest/quick-start.html#firewall
#+begin_src bash
  configure
  # WAN firewall (allow the forwarded traffic)
  set firewall ipv4 name WAN_IN default-action drop
  set firewall ipv4 name WAN_IN rule 10 action accept
  set firewall ipv4 name WAN_IN rule 10 state established enable
  set firewall ipv4 name WAN_IN rule 10 state related enable

  set firewall ipv4 name WAN_IN rule 20 description 'Allow PVE 8006 DNAT'
  set firewall ipv4 name WAN_IN rule 20 action accept
  set firewall ipv4 name WAN_IN rule 20 protocol tcp
  set firewall ipv4 name WAN_IN rule 20 destination address 192.168.1.12
  set firewall ipv4 name WAN_IN rule 20 destination port 8006

  # Attach WAN_IN to wlan0 (wireless interface)
  # set interfaces <wan-type> <wan-if> firewall in name WAN_IN   # e.g., 'wireless wlan0' or 'ethernet eth0'
  set interfaces wireless wlan0 firewall in name wlan0 

  commit
  save
#+end_src

*** Commit and Save
After every configuration change, you need to apply the changes by using the following command:
#+begin_src bash
commit
#+end_src

Once your configuration works as expected, you can save it permanently by using the following command:
#+begin_src bash
save
#+end_src
*** Optional: hairpin for LAN clients using the WAN IP
If machines on 192.168.1.0/24 will reach the service via the gateway’s WAN IP (not the VM IP), add a second DNAT for hairpin:
#+begin_src bash
# On gw1 (repeat on gw2 with its WAN IP if needed)
set nat destination rule 11435 description 'Hairpin 8006 LAN->WANIP -> VM'
set nat destination rule 11435 inbound-interface <lan-if>
set nat destination rule 11435 protocol tcp
set nat destination rule 11435 destination address <gw1-wan-ip>
set nat destination rule 11435 destination port 8006
set nat destination rule 11435 translation address 192.168.1.3 # LAN Clients IP
set nat destination rule 11435 translation port 8006
commit; save
#+end_src
Hairpin NAT (aka NAT loopback or U-turn NAT) lets a host inside your LAN reach a service that you’ve published on the gateway’s WAN IP, even though the server is also inside the LAN.

* WWAN - Wireless Wide-Area-Network
:PROPERTIES:
:ID:       049298d5-7b83-4ce2-8cfe-c6e50bf141a7
:END:
https://docs.vyos.io/en/stable/configuration/interfaces/wwan.html

** Supported LTE cards
+ Sierra Wireless AirPrime MC7304 miniPCIe card (LTE)
+ Sierra Wireless AirPrime MC7430 miniPCIe card (LTE)
+ Sierra Wireless AirPrime MC7455 miniPCIe card (LTE)
+ Sierra Wireless AirPrime MC7710 miniPCIe card (LTE)
+ Huawei ME909u-521 miniPCIe card (LTE)
+ Huawei ME909s-120 miniPCIe card (LTE)
  
** Supported [[id:632cf3c1-f7dc-4e2f-9ca7-e701322621bd][WIFI]] cards
VyOS is based on Debian (depends on the version, like 1.3 → Debian 10 "Buster"), so Wi-Fi card compatibility is similar to Debian Linux. These chipsets are usually your safest bet:

*** Atheros AR9xxx series (ath9k)
✅ Fully open-source drivers
✅ Stable and well-supported in Debian
Works in both AP and client mode
Good for hostapd (if you're trying to make VyOS a Wi-Fi AP)

* Reference List
1. https://docs.vyos.io/en/sagitta/
2. https://forum.vyos.io/t/article-vyos-for-home-use/14715
3. https://akyriako.medium.com/configure-vyos-as-a-software-based-router-for-your-home-labs-private-networks-a0f4529f0b99
4. https://en.wikipedia.org/wiki/VyOS
