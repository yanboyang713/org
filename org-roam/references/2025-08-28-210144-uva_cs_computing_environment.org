:PROPERTIES:
:ID:       dd8e5d6f-b01b-4a3d-ba1c-832a27e7e243
:END:
#+title: UVA CS Computing Environment
#+date: 2025-08-28

[[id:bc1f11cb-958e-43fa-88a2-904fd94805db][University of Virginia]]

* UVA CS Project Directories
:PROPERTIES:
:ID:       809692d6-aefe-4680-b292-52f79ebb0199
:END:
https://www.cs.virginia.edu/computing/doku.php?id=project_directories

Project directory /p/nmg5g

** Attach CS Project Directory/CIFS to Arch Linux
*** Install SMB/CIFS tools
#+begin_src bash
sudo pacman -Syu --needed cifs-utils gvfs-smb smbclient keyutils
#+end_src
*** Create a mount point
#+begin_src bash
sudo mkdir -p /mnt/nmg5g
#+end_src
*** Quick test mount
Use the same server and share as on Proxmox, and similar vers= if you set it there:
#+begin_src bash
sudo mount -t cifs //samba.cs.virginia.edu/p/nmg5g /mnt/nmg5g -o "username=rhe9cf,domain=CSDOM,vers=3.0,uid=$(id -u),gid=$(id -g),file_mode=0644,dir_mode=0755"
#+end_src
  - Enter the password when prompted and check the contents: ls /mnt/nmg5g.
  - If it fails, try another vers= (e.g. 2.1, 3.1.1).

umount:
#+begin_src bash
sudo umount /mnt/nmg5g
#+end_src
*** persistent, create credentials and fstab
Create credentials file
#+begin_src bash
  sudo mkdir -p /etc/samba
  sudo vim /etc/samba/creds.nmg5g
#+end_src

Contents:
#+begin_src file
username=rhe9cf
password=YOUR_PASSWORD_HERE
domain=CSDOM
#+end_src

Then:
#+begin_src bash
sudo chmod 600 /etc/samba/creds.nmg5g
#+end_src

Add fstab entry

Edit /etc/fstab:
#+begin_src bash
  sudo vim /etc/fstab
#+end_src

Add this line (adjust uid/gid if needed):
#+begin_src file
//samba.cs.virginia.edu/p/nmg5g /mnt/nmg5g cifs _netdev,nofail,credentials=/etc/samba/creds.nmg5g,vers=3.0,uid=1000,gid=1000,file_mode=0644,dir_mode=0755  0  0
#+end_src

Test
#+begin_src bash
  sudo umount /mnt/nmg5g   # ignore error if not mounted
  sudo mount -a
  ls /mnt/nmg5g
#+end_src

** [[id:250c2326-0ec0-4063-93ab-3a2b27e8d2ae][Proxmox’s CIFS storage]] 

* UVA CS [[id:822ba079-5358-4814-94f5-66a7f741b41a][Slurm]] cluster
:PROPERTIES:
:ID:       b5392aff-d459-450c-b18c-a41152a869b3
:END:

https://www.cs.virginia.edu/computing/doku.php?id=compute_slurm#resource_limits

** Create a project-scoped env
Pick a path under your project dir (example: /p/nmg5g/condaenvs/py312):
#+begin_src bash
# on a login node (portal) or short salloc
module load miniforge
mkdir -p /p/nmg5g/condaenvs

# create the env *by path* so it lives in /p
conda create -y --prefix /p/nmg5g/condaenvs/py312 python=3.12
#+end_src

To use it interactively:
#+begin_src bash
module load miniforge
# make 'conda activate' available in non-interactive shells
source "$(conda info --base)/etc/profile.d/conda.sh"
conda activate /p/nmg5g/condaenvs/py312
python -V
#+end_src

** Keep caches out of /u (optional but recommended)
By default, Conda’s package cache and named envs live in your home. Redirect them to /p with a .condarc:
#+begin_src bash
rhe9cf@portal03:~$ cd
rhe9cf@portal03:~$ pwd
/u/rhe9cf
#+end_src

#+begin_src bash
# create/edit ~/.condarc
cat >> ~/.condarc <<'YAML'
envs_dirs:
  - /p/nmg5g/conda/envs
pkgs_dirs:
  - /p/nmg5g/conda/pkgs
YAML

mkdir -p /p/nmg5g/conda/envs /p/nmg5g/conda/pkgs
#+end_src
Conda reads .condarc to set envs_dirs and pkgs_dirs. You can also use conda config --add envs_dirs ... / --add pkgs_dirs ....

** Use the env in Slurm jobs
create hello.py
#+begin_src python
import sys, multiprocessing as mp
print("Python:", sys.version)
print("CPUs visible:", mp.cpu_count())
#+end_src

create conda_example.slurm
#+begin_src file
#!/bin/bash
#SBATCH -p cpu
#SBATCH --cpus-per-task=4
#SBATCH --mem=8G
#SBATCH -t 01:00:00
#SBATCH -J conda-demo
#SBATCH --output=slurm-%A.out

set -euo pipefail
module --ignore_cache purge
module load miniforge

# make `conda activate` work in batch shells
source "$(conda info --base)/etc/profile.d/conda.sh"
conda activate /p/nmg5g/condaenvs/py312

echo "Python: $(python -V) @ $(which python)"
export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK

# use heredoc with the *activated* interpreter
srun python hello.py
#+end_src

run:
#+begin_src bash
sbatch conda_example.slurm
#+end_src

#+begin_src bash
squeue -u rhe9cf
#+end_src

* Reference List
1. https://www.cs.virginia.edu/computing/doku.php?id=start
